<!doctype html>
<html lang="es" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>StudyForge ‚Äî Mis documentos</title>

    <!-- Tailwind para prototipo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: { extend: { colors: { brand: { 500: "#7C3AED" } } } },
      };
    </script>

    <style>
      :root { color-scheme: dark; }
      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
      .dropzone.dragover { border-color: #7C3AED; background-color: rgba(124,58,237,.08); }
      .fade-in { animation: fade .18s ease-out; }
      @keyframes fade { from{opacity:.0; transform:translateY(2px)} to{opacity:1; transform:none} }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>

    <script>
      const API_BASE = "http://localhost:8000";

      function getToken() {
        return localStorage.getItem("sf_token") || sessionStorage.getItem("sf_token");
      }
      function logout() {
        localStorage.removeItem("sf_token");
        sessionStorage.removeItem("sf_token");
        window.location.href = "/index.html";
      }
      function toast(msg) {
        const el = document.getElementById("toast");
        el.textContent = msg;
        el.classList.remove("hidden");
        setTimeout(() => el.classList.add("hidden"), 2300);
      }
      function escapeHtml(str) {
        return String(str ?? "")
          .replaceAll("&", "&amp;").replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;").replaceAll('"', "&quot;");
      }

      async function fetchMe(token) {
        try {
          const res = await fetch(`${API_BASE}/auth/me`, { headers: { Authorization: `Bearer ${token}` } });
          if (res.status === 401) throw new Error("unauthorized");
          if (!res.ok) return null;
          return await res.json();
        } catch { return null; }
      }
      async function fetchDocuments(token) {
        const res = await fetch(`${API_BASE}/documents`, { headers: { Authorization: `Bearer ${token}` } });
        if (res.status === 401) throw new Error("unauthorized");
        if (!res.ok) throw new Error("fetch_error");
        return await res.json();
      }
      async function createDocument(token, payload) {
        const res = await fetch(`${API_BASE}/documents`, {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
          body: JSON.stringify(payload),
        });
        if (res.status === 401) throw new Error("unauthorized");
        if (res.status === 422) throw new Error("validation");
        if (!res.ok) throw new Error("create_error");
        return await res.json();
      }

      function renderList(data) {
        const list = document.getElementById("doc-list");
        list.innerHTML = "";
        const items = (data && data.items) || [];
        if (!items.length) {
          list.innerHTML = `<li class="text-slate-400 text-sm">No tienes documentos a√∫n. Crea el primero üëá</li>`;
          return;
        }
        for (const d of items) {
          const li = document.createElement("li");
          li.className = "rounded-xl bg-slate-800/60 border border-slate-700 px-4 py-3 fade-in";
          li.innerHTML = `
            <div class="font-semibold text-white">${escapeHtml(d.title ?? "(Sin t√≠tulo)")}</div>
            <div class="text-sm text-slate-400">${escapeHtml(d.description ?? "")}</div>
          `;
          list.appendChild(li);
        }
      }

      // ============ NUEVA LECTURA ROBUSTA DE TEXTO ============
      function readAsTextUtf8(file) {
        return new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(String(r.result ?? ""));
          r.onerror = () => reject(r.error || new Error("read_error_utf8"));
          r.readAsText(file, "utf-8");
        });
      }
      function readAsTextDefault(file) {
        return new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(String(r.result ?? ""));
          r.onerror = () => reject(r.error || new Error("read_error_default"));
          r.readAsText(file);
        });
      }
      function readAsDecoded(file, encoding) {
        return new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => {
            try {
              const buf = r.result; // ArrayBuffer
              const dec = new TextDecoder(encoding, { fatal: false });
              resolve(dec.decode(buf));
            } catch (e) {
              reject(e);
            }
          };
          r.onerror = () => reject(r.error || new Error("read_error_buffer"));
          r.readAsArrayBuffer(file);
        });
      }

      async function readFileAsTextSmart(file) {
        const ext = (file.name.split(".").pop() || "").toLowerCase();
        const isTxtExt = ["txt","md","csv","log"].includes(ext);
        const isTextMime = (file.type || "").startsWith("text/");

        console.info("[D&D] file:", { name: file.name, type: file.type, size: file.size, ext });

        if (!(isTxtExt || isTextMime) && file.type && !file.type.startsWith("text/")) {
          // MIME expl√≠citamente no text/*
          throw new Error("unsupported_format");
        }

        // 1) Intento principal: readAsText UTF-8
        try {
          let t = await readAsTextUtf8(file);
          if (t.charCodeAt(0) === 0xFEFF) t = t.slice(1); // quita BOM
          t = t.replace(/\r\n/g, "\n");
          if (t.length) return t;
        } catch (e) {
          console.warn("readAsText('utf-8') fall√≥:", e);
        }

        // 2) readAsText sin encoding (algunos navegadores/archivos antiguos)
        try {
          let t = await readAsTextDefault(file);
          if (t.charCodeAt(0) === 0xFEFF) t = t.slice(1);
          t = t.replace(/\r\n/g, "\n");
          if (t.length) return t;
        } catch (e) {
          console.warn("readAsText() por defecto fall√≥:", e);
        }

        // 3) ArrayBuffer + TextDecoder UTF-8
        try {
          let t = await readAsDecoded(file, "utf-8");
          if (t.charCodeAt(0) === 0xFEFF) t = t.slice(1);
          t = t.replace(/\r\n/g, "\n");
          if (t.length) return t;
        } catch (e) {
          console.warn("ArrayBuffer+TextDecoder('utf-8') fall√≥:", e);
        }

        // 4) Fallbacks comunes para Windows (no todos los navegadores soportan estos label)
        for (const enc of ["windows-1252", "latin1"]) {
          try {
            let t = await readAsDecoded(file, enc);
            if (t.length) return t;
          } catch (e) {
            console.warn(`ArrayBuffer+TextDecoder('${enc}') fall√≥:`, e);
          }
        }

        // 5) √öltimo intento: si no trae type (muchos .txt), probamos igualmente como text si es peque√±o
        if (!file.type && file.size <= 5 * 1024 * 1024) {
          try {
            let t = await readAsTextUtf8(file);
            if (t.length) return t;
          } catch (e) {
            console.warn("√öltimo intento utf-8 sin type tambi√©n fall√≥:", e);
          }
        }

        throw new Error("unreadable_text");
      }
      // =========================================================

      function hookDropzone() {
        const dz = document.getElementById("dropzone");
        const fileInput  = document.getElementById("file-input");
        const titleEl    = document.getElementById("title");
        const descEl     = document.getElementById("description");
        const contentEl  = document.getElementById("content");

        async function handleFiles(fileList) {
          if (!fileList || !fileList.length) return;
          const file = fileList[0];

          // Sugerir t√≠tulo/desc si faltan
          const base = file.name.replace(/\.[^/.]+$/, "");
          if (!titleEl.value.trim()) titleEl.value = base;
          if (!descEl.value.trim())  descEl.value  = `Importado desde archivo (${file.name})`;

          try {
            const text = await readFileAsTextSmart(file);
            contentEl.value = text; // <-- AQU√ç LLENAMOS EL TEXTAREA
            console.info(`[D&D] le√≠do ${text.length} caracteres`);
            toast(`Archivo importado ‚úÖ (${text.length} chars)`);
          } catch (err) {
            console.error("lectura fall√≥:", err);
            if (String(err.message) === "unsupported_format") {
              toast("Formato no soportado para extracci√≥n. Usa .txt/.md por ahora.");
            } else {
              toast("No se pudo leer el archivo. Abre la consola para m√°s detalles.");
            }
          }
        }

        dz.addEventListener("click", () => fileInput.click());
        ["dragenter","dragover"].forEach(ev =>
          dz.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); dz.classList.add("dragover"); })
        );
        ["dragleave","drop"].forEach(ev =>
          dz.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); dz.classList.remove("dragover"); })
        );
        dz.addEventListener("drop", (e) => {
          const files = e.dataTransfer?.files;
          handleFiles(files);
        });

        fileInput.addEventListener("change", () => {
          handleFiles(fileInput.files);
          fileInput.value = "";
        });
      }

      async function init() {
        const token = getToken();
        if (!token) { window.location.replace("/src/pages/login.html"); return; }

        const me = await fetchMe(token);
        if (me && me.email) {
          const el = document.getElementById("user-email");
          if (el) el.textContent = me.email;
        }

        try {
          const data = await fetchDocuments(token);
          renderList(data);
        } catch (e) {
          if (String(e.message) === "unauthorized") { logout(); return; }
          toast("No se pudieron cargar tus documentos.");
        }

        hookDropzone();

        const form = document.getElementById("doc-form");
        form.addEventListener("submit", async (ev) => {
          ev.preventDefault();
          const title = document.getElementById("title").value.trim();
          const description = document.getElementById("description").value.trim();
          const content = document.getElementById("content").value.trim();

          if (!title || !content) { toast("T√≠tulo y contenido son obligatorios."); return; }

          try {
            const created = await createDocument(getToken(), { title, description, content });
            toast("Documento creado ‚úÖ");
            const li = document.createElement("li");
            li.className = "rounded-xl bg-slate-800/60 border border-slate-700 px-4 py-3 fade-in";
            li.innerHTML = `
              <div class="font-semibold text-white">${escapeHtml(created.title ?? title)}</div>
              <div class="text-sm text-slate-400">${escapeHtml(created.description ?? description)}</div>
            `;
            const list = document.getElementById("doc-list");
            if (list.firstChild && list.firstChild.textContent?.includes("No tienes documentos")) {
              list.innerHTML = "";
            }
            list.prepend(li);
            form.reset();
          } catch (e) {
            if (String(e.message) === "unauthorized") { logout(); return; }
            if (String(e.message) === "validation") { toast("Revisa los datos (no se permiten vac√≠os)."); return; }
            toast("No se pudo crear el documento.");
          }
        });
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </head>

  <body class="min-h-screen bg-slate-950 text-white">
    <!-- barra -->
    <header class="sticky top-0 z-10 bg-slate-900/80 backdrop-blur border-b border-slate-800">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-8 w-8 rounded-full bg-brand-500 ring-8 ring-brand-500/20"></span>
          <span class="font-bold">StudyForge</span>
          <span class="text-slate-400 text-sm hidden sm:inline">Mis documentos</span>
        </div>
        <div class="flex items-center gap-4">
          <span id="user-email" class="text-slate-300 text-sm"></span>
          <button onclick="logout()" class="rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 py-1.5 text-sm">
            Cerrar sesi√≥n
          </button>
        </div>
      </div>
    </header>

    <!-- contenido -->
    <main class="max-w-6xl mx-auto px-4 py-8 grid lg:grid-cols-2 gap-8">
      <!-- formulario / drop -->
      <section class="rounded-2xl bg-slate-900/70 border border-slate-800 p-6">
        <h2 class="text-xl font-semibold">Crear documento</h2>
        <p class="text-slate-400 text-sm mb-4">
          Puedes arrastrar un <span class="mono">.txt</span> o <span class="mono">.md</span>, o pegar el contenido abajo. <br/>
          Para <span class="mono">PDF/DOCX</span> agregaremos extracci√≥n en el paso 8.
        </p>

        <!-- Dropzone -->
        <div id="dropzone" class="dropzone rounded-xl border-2 border-dashed border-slate-700 bg-slate-800/50 p-6 mb-4 cursor-pointer text-center">
          <input id="file-input" type="file" accept=".txt,.md,text/plain,text/markdown" class="hidden" />
          <div class="flex flex-col items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-slate-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4a5 5 0 0 0-5 5H5l3.5 3.5L12 9h-2a3 3 0 1 1 3 3v2a5 5 0 0 0-1-10Z"/><path d="M5 18h14v2H5z"/></svg>
            <p><b>Arrastra tu archivo</b> o haz click para seleccionarlo</p>
            <p class="text-xs text-slate-400">Acepta .txt, .md y otros <span class="mono">text/*</span>. PDF/DOCX pr√≥ximamente.</p>
          </div>
        </div>

        <form id="doc-form" class="space-y-4">
          <div>
            <label for="title" class="block text-sm text-slate-300 mb-1">T√≠tulo *</label>
            <input id="title" type="text" required maxlength="200"
              class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 outline-none focus:border-brand-500" />
          </div>

          <div>
            <label for="description" class="block text-sm text-slate-300 mb-1">Descripci√≥n</label>
            <input id="description" type="text" maxlength="300"
              class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 outline-none focus:border-brand-500" />
          </div>

          <div>
            <label for="content" class="block text-sm text-slate-300 mb-1">Contenido *</label>
            <textarea id="content" required rows="8"
              class="w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 outline-none focus:border-brand-500 mono"></textarea>
          </div>

          <button type="submit" class="rounded-full bg-brand-500 px-5 py-2.5 font-semibold shadow hover:opacity-95">
            Crear
          </button>
        </form>
      </section>

      <!-- lista -->
      <section class="rounded-2xl bg-slate-900/70 border border-slate-800 p-6">
        <h2 class="text-xl font-semibold mb-4">Tus documentos</h2>
        <ul id="doc-list" class="space-y-3">
          <li class="text-slate-400 text-sm">Cargando‚Ä¶</li>
        </ul>
      </section>
    </main>

    <!-- toast -->
    <div id="toast" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-slate-900/90 border border-slate-700 rounded-xl px-4 py-2 text-sm"></div>
  </body>
</html>
